---
title: "Forecasting San Diego Power Consumption"
author: "Hunter Blum, Mackenzie Carter, Saba Alemayehu"
date: '2022-11-06'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Libraries
```{r}
library(readxl)
library(rstudioapi)
library(parsedate)
library(lubridate)
library(psych)
library(corrplot)
library(outliers)

# Note - Tidyverse is a collection of packages, see the Attaching packages section below. Usually best to load last so its functions will mask over other packages.
library(tidyverse)
```

Set Working Directory
```{r}
setwd(dirname(getActiveDocumentContext()$path))
getwd()
```

# Read and Join Data
### San Diego Energy Data
```{r}
SD_energy <- list.files(path = paste0(getwd(), "/EnergyData"),
                        pattern = "*.xlsx",
                        full.names = T) %>% 
  lapply(read_excel) %>% 
  bind_rows()

# They changed the hour variable name between HE and HR, so we'll combine them. CAISO Total was also replaced with CAISO but will be deleted later. Since all NAs are due to name changes it won't be a problem to fill with zero and then sum them to get consistent variable names.

colSums(is.na(SD_energy))
SD_energy <- SD_energy %>% select(!...8)
SD_energy[is.na(SD_energy)] <- 0
SD_energy$HR <- SD_energy$HE + SD_energy$HR


# Get rid of the duplicate variables and non-San Diego company data.
SD_energy <- SD_energy %>% select(-c("HE", "CAISO", "PGE", "SCE", "VEA", "CAISO Total"))
```

### San Diego Weather Data
```{r}
SD_weather <- read.csv("Weather.csv")
```

### Joining
Clean Energy Dates
```{r}
SD_energy <- SD_energy %>% mutate(HR = HR-1)
SD_energy$Date <- ymd_h(paste0(SD_energy$Date, SD_energy$HR))

# Shouldn't need hour variable anymore
SD_energy <- SD_energy %>% select(!HR)
```

Clean Weather Dates
```{r}
# Source 4 takes a measurement every six hours. Source 7 is hourly, so we'll keep Source 7 data.
SD_weather <- SD_weather %>% filter(SOURCE == 7)
SD_weather$DATE <- as_datetime(parse_iso_8601(SD_weather$DATE))  
SD_weather$DATE <- round_date(SD_weather$DATE, unit = "hour")
```

Join
```{r}
SD <- SD_energy %>% left_join(SD_weather, by = c('Date' = 'DATE'))
```

Write
```{r}
write.csv(SD, "SD.csv")
```

# EDA/Cleaning 
Read in data (So you can skip first part)
```{r}
setwd(dirname(getActiveDocumentContext()$path))
SD <- read.csv("SD.csv")
SD <- SD[,-1]
SD <- SD %>% select(Date, SDGE, starts_with("Hourly"))
head(SD)
```

## Structual and General EDA

First, lets take a broad look at our data, including variable types, descriptive statistics and NA counts. 

```{r}
str(SD)
describe(SD)
```

```{r}
#visualizing missing values
missing.values <- SD %>%
    gather(key = "key", value = "val") %>%
    mutate(is.missing = is.na(val)) %>%
    group_by(key, is.missing) %>%
    summarise(num.missing = n()) %>%
    filter(is.missing==T) %>%
    select(-is.missing) %>%
    arrange(desc(num.missing)) 
missing.values %>%
  ggplot() +
    geom_bar(aes(x=key, y=num.missing), stat = 'identity') +
    labs(x='variable', y="number of missing values", title='Number of missing values') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Numeric EDA ##

```{r}
SD$HourlyDryBulbTemperature <- as.numeric(as.character(SD$HourlyDryBulbTemperature))
SD$HourlyDewPointTemperature <- as.numeric(as.character(SD$HourlyDewPointTemperature))
SD$HourlyPrecipitation <- as.numeric(as.character(SD$HourlyPrecipitation))
num <- SD %>% dplyr::select(where(is.numeric))
describe(num)
summary(num)
```

Some columns are almost entirely NA values, for sake of early EDA, we will be dropping these columns for now. 
```{r}
drop <- c("HourlyWindGustSpeed","HourlyPressureTendency", "HourlyPressureChange", "HourlySeaLevelPressure", "HourlyPrecipitation", "HourlyPrecipitation", "HourlyDewPointTemperature")
num = num[,!(names(num) %in% drop)]
summary(num)
```

Our remaining NA's will be replaced with the median of its column. 
```{r}
num_fill <- num %>% mutate(across(where(is.numeric), ~replace_na(., median(., na.rm=TRUE))))
summary(num_fill)
```

## Outliers ## 
```{r}
tests = lapply(num_fill, grubbs.test) 
tests
```
The grubbs test shows our max value for wind speed, 33, is an outlier. This makes sense because wind speed ranges in the single digits- it is likely that 33 was a typo. 

## Corrplot ##
```{r}
M = cor(num_fill)
corrplot(M, addCoef.col = 'black')
```
As we can see from our corrplot, hourly station pressure and hourly altimeter setting are 100% correlated, hourly dry bulb and wet bulb temperature are closely correlated as well. We will be keeping dry bulb temperature as that correlates to ambient temperature. Altimeter setting is another measure of pressure, so we will be keeping hourly station pressure for ease of understanding. 

```{r}
drop2 <- c("HourlyWetBulbTemperature","HourlyAltimeterSetting")
num_fill2 = num_fill[,!(names(num_fill) %in% drop2)]
M2 = cor(num_fill2)
corrplot(M2, addCoef.col = 'black')
```

```{r}
ggplot(data = num_fill2, aes(x= HourlyDryBulbTemperature, y=SDGE)) + 
  geom_point() + 
  labs(title="SDGE Usage By Temp", 
         x="Dry Bulb Temp (Â°F)", y = "Hourly Energy Use (MWh)")
  
```
